---
title: "Aula 7 - Estat√≠stica inferencial: ANOVA"
author: "Caio"
format: html
editor: visual
execute: 
  error: false
  warning: false
---

# Aula 07

## Carregando os pacotes

```{r}
library(gsheet)
library(tidyverse)
library(performance)
library(DHARMa)
library(emmeans)
library(multcomp)
library(multcompView)
```

## Exemplo de An√°lise de Vari√¢ncia (ANOVA)

Para realizar a an√°lise de vari√¢ncia (ANOVA), ser√° carregado um conjunto de dados presente no R (conjunto `InsectSprays`), que ser√° atribu√≠do a um objeto:

```{r}
inseticida <- InsectSprays

inseticida %>% 
  count(spray)
```

Com a f√≥rmula `count`, identificamos que nesse conjunto de dados h√° um fator (inseticida), com 6 n√≠veis (tipos de inseticidas), cada n√≠vel com 12 observa√ß√µes.\

## Explorando o conjunto

```{r}
inseticida %>%
  ggplot(aes(spray, count))+
  geom_boxplot(width = 0.5)
```

Com o boxplot gerado, √© poss√≠vel notar que h√° tratamentos que diferem dos demais.\

## Ajustar o modelo para ANOVA

Para realizar a ANOVA √© preciso ajustar um modelo (`lm`). Isso √© necess√°rio para que os res√≠duos possam ser aplicados nos testes para verifica√ß√£o das premissas da anova. O modelo ser√° atribu√≠do a um objeto.

```{r}
m1 <- lm(count~spray, data = inseticida)
summary(m1)
```

### ANOVA

Uma vez definido o modelo, ele ser√° utilizado como um argumento na fun√ß√£o `anova`:

```{r}
anova(m1)
```

Com a an√°lise de vari√¢ncia e interpreta√ß√£o da estat√≠stica "*F*" √© poss√≠vel dizer que dentre os tratamentos, h√° algum que difere estatisticamente dos demais.\
\

## Avalia√ß√£o das premissas

### Estrat√©gia 1

Primeiro, ser√° analisada a normalidade dos res√≠duos de maneira visual (fun√ß√£o `hist`) e estatisticamente (fun√ß√£o `shapiro.test`).

```{r}
hist(m1$residuals)

shapiro.test(m1$residuals)
```

Apesar do histograma possuir aspecto de normalidade, o teste de Shapiro-Wilk demonstra que os res√≠duos n√£o possuem normalidade (valor de P = 0.02).\
\
A normalidade tamb√©m pode ser avaliada visualmente em um gr√°ifco Q-Q, com as fun√ß√µes `qqnorm` e `qqline`:

```{r}
qqnorm(m1$residuals)
qqline(m1$residuals)
```

O gr√°fico Q-Q mostra que os pontos desviam da linha de normalidade apenas nas regi√µes extremas, o que justifica o fato do teste de Shapiro-Wilk ter rejeitado a hip√≥tese de normalidade dos res√≠duos.\
\
\
Em sequ√™ncia, com o teste de Bartlett (`bartlett.test`), ser√° avaliada a homogeneidade das vari√¢ncias entre os grupos:

```{r}
bartlett.test(count ~ spray,
              data = inseticida)
```

O teste de Bartlett demonstra que as vari√¢ncias s√£o heterog√™neas, pois valor de P √© menor que 0.01.

### Estrat√©gia 2

Usando o pacote **`performance`**:

```{r}
check_normality(m1)
```

```{r}
check_heteroscedasticity(m1)
```

O testes `check_normality` e `check_heteroscedasticity` resultaram em n√£o normalidade dos res√≠duos e heterocedasticidade entre os grupos.

### Estrat√©gia 3

Com o pacote **`DHARMa`**:

```{r}
plot(simulateResiduals(m1))
```

Da mesma forma que as estrat√©gias anteriores, aqui observa-se falta de normalidade e homogeneidade entre as vari√¢ncias dos grupos.

## Transforma√ß√£o dos dados

Diante dos resultados obtidos, conclui-se que o conjunto de dados n√£o atende as pressuposi√ß√µes da ANOVA, logo √© necess√°rio definir uma estrat√©gia para prosseguir na an√°lise dos dados. √â poss√≠vel realizar transforma√ß√µes da vari√°vel resposta, adotar um teste n√£o-param√©trico (por exemplo, teste de Kruskal-Wallis), ou utilizar um modelo linear generalizado (Generalized Linear Model - GLM). A seguir, s√£o apresentados exemplos de como se adotar cada estrat√©gia:

### Alternativa 1 - Raiz quadrada

Os dados ser√£o transformados com a fun√ß√£o `sqrt` e a coluna da vari√°vel resposta ser√° substitu√≠da com os novos valores:

```{r}
inseticida <- inseticida %>% 
  mutate(count2 = sqrt(count))

glimpse(inseticida)
```

#### An√°lise visual dos dados transformados

```{r}
inseticida %>%
  ggplot(aes(spray, count2))+
  geom_boxplot(width = 0.5)

```

Visualmente, √© poss√≠vel dizer que, possivelmente, os dados transformados agora possuem normalidade e homocedasticidade, pois os valores de mediana tendem a se encontrar nos centros da caixas e essas tem tamanho mais ou menos similar entre si.

#### Ajuste do novo modelo

```{r}
m2 <- lm(count2 ~ spray,
         data = inseticida)

summary(m2)
```

#### ANOVA com os novos dados

```{r}
anova (m2)
```

Mesmo ap√≥s transforma√ß√£o, os dados continuem apresentando diferen√ßa significativa, ou seja, h√° pelo menos uma m√©dia que difere das demais.

#### Avalia√ß√£o das premissas - Normalidade

```{r}
hist(m2$residuals)
```

```{r}
qqnorm(m2$residuals)
qqline(m2$residuals)
```

```{r}
shapiro.test(m2$residuals)
```

Visual e estatisticamente, conclui-se que os res√≠duos do conjunto de dados transformados possuem distribui√ß√£o normal.

#### Avalia√ß√£o das premissas - Homocedasticidade

```{r}
bartlett.test(count2 ~ spray,
              data = inseticida)
```

Ap√≥s a transforma√ß√£o, √© poss√≠vel dizer que h√° homogeneidade de vari√¢ncias entre os grupos.

#### Avalia√ß√£o das premissas - Pacote `performance`:

```{r}
check_normality(m2)
check_heteroscedasticity(m2)
```

#### Avalia√ß√£o das premissas - Pacote **`DHARMa`**

```{r}
plot(simulateResiduals(m2))
```

Ap√≥s os v√°rios testes realizados, temos confian√ßa que os dados transformados possuem distribui√ß√£o normal e homogeneidade das vari√¢ncias. Logo, √© poss√≠vel realizar compara√ß√µes de m√©dias.

### Compara√ß√£o de m√©dias

#### Para o modelo 1 - n√£o transformado (n√£o atendendo √†s pressuposi√ß√µes):

Apenas √† t√≠tulo de curiosidade, ser√° feita uma compara√ß√£o de m√©dias com base nos valores originais. O que n√£o √© correto, uma vez que esses n√£o satisfazem as pressuposi√ß√µes da ANOVA.\
Para isso, a fun√ß√£o `emmeans`, indicando o modelo (m1) e os tratamentos (spray), ser√° atribu√≠da a um objeto.

```{r}
m1_medias <- emmeans(m1, ~ spray)
plot(m1_medias)
```

O gr√°fico gerado mostra que para essa situa√ß√£o, os tratamentos tendem a formar dois grupos de efici√™ncia.

```{r}
multcomp::cld(m1_medias)
```

O que √© comprovado estatisticamente pela compara√ß√£o de m√©dias, utilizando o teste de Tukey.

#### Para o modelo 2 - transformado

Para os dados transformados, ser√£o aplicados os mesmos passos descritos acima:

```{r}
m2_medias <- emmeans(m2, ~ spray)
plot(m2_medias)
```

Visualmente, √© poss√≠vel dizer que os inseticidas formam tr√™s grupos distintos.

```{r}
multcomp::cld(m2_medias)
```

Com a m√©dia transformada, o teste de Tukey agrupa os tratamentos em 3 grupos distintos, logo houve melhor discrimina√ß√£o. Com isso, conclu√≠mos que, em compara√ß√£o aos demais, o inseticida C foi o mais eficiente, pois apresentou menor n√∫mero de insetos contados. Em seguida, os inseticidas E e D apresentaram desempenho intermedi√°rio. Por fim, h√° um grupo com os inseticidas menos eficientes, nesse caso, contendo os tratamentos A, B e F.

#### Alternativas para visualiza√ß√£o das compara√ß√µes de m√©dias

#### Fun√ß√£o `pwpm`:

A fun√ß√£o `pwpm` (`emmeans`) constr√≥i uma matriz de valores de probabilidade, onde s√£o apresentadas as compara√ß√µes entre tratamentos, par a par. Nas diagonais, entre colchetes, s√£o apresentados os valores de m√©dia de cada tratamento.

```{r}
pwpm(m2_medias)
```

#### Fun√ß√£o `pwpp`:

A fun√ß√£o `pwpp` (`emmeans`) constr√≥i uma plotagem de valores de probabilidade associados as compara√ß√µes pareadas das m√©dias marginais estimadas.

```{r}
pwpp (m2_medias)
```

#### Fun√ß√£o `pairs`:

A fun√ß√£o `pairs` apresenta os contrastes ortogonais dos valores de m√©dias dos tratamentos, associados aos valores de probabilidade.

```{r}
pairs(m2_medias)
```

### Alternativa 1.2 - Transforma√ß√£o de Box--Cox

Para tentar sanar o problema da falta de normalidade e/ou heterocedasticidade, √© poss√≠vel utilizar um segundo tipo de transforma√ß√£o, neste caso a transforma√ß√£o de Box-Cox.

A transforma√ß√£o de Box-Cox se baseia na seguinte equa√ß√£o:

$y_{(\lambda)} = (y^{\lambda} - 1)/ \lambda$

Onde, y representa a vari√°vel resposta original; $y_{(\lambda)}$ √© a vari√°vel resposta transformada; e lambda (ùõå) √© o par√¢metro de transforma√ß√£o, variando entre - ‚àû e + ‚àû.

\
Para conduzir essa transforma√ß√£o, √© utilizada a fun√ß√£o `boxcox` (pacote `MASS`). A fun√ß√£o calcula e identifica o valor ùõå √≥timo para um determinado conjunto de dados (onde o valor de Y √© m√°ximo).

```{r}
library(MASS)

b <- boxcox(lm(inseticida$count + 0.1 ~ 1))
```

```{r}
lambda <- b$x [which.max(b$y)]
lambda
```

Com os comandos acima √© poss√≠vel determinar na equa√ß√£o (b) o valor de ùõå (no eixo x), cujo valor de y √© m√°ximo. Logo, para o conjunto em an√°lise, ùõå ‚âÖ 0.42.

#### Transformando os dados com Box-Cox

Com o valor calculado acima, realiza-se a transforma√ß√£o de Box-Cox:

```{r}
inseticida$count3 <-(inseticida$count ^ lambda - 1) / lambda
```

\
Novo modelo

```{r}
m3 <- lm(count3 ~ spray,
         data = inseticida)
```

\
Avalia√ß√£o de normalidade e homogeneidade de vari√¢ncias entre os grupos:

```{r}
hist(inseticida$count3)
```

```{r}
qqnorm (m3$residuals)
qqline (m3$residuals)

shapiro.test(m3$residuals)
```

```{r}
bartlett.test(count3 ~ spray,
              data = inseticida)
```

Com a transforma√ß√£o de Box-Cox, os dados passaram a possuir normalidade e homocedasticidade, satisfazendo as pressuposi√ß√µes da ANOVA. Em seguida poderiam ser feitos ANOVA e compara√ß√£o de m√©dias como j√° demonstrado anteriormente.

### Alternativa 2 - Usar um teste n√£o param√©trico

Como a vari√°vel resposta do conjunto de dados em estudo √© do tipo num√©rica discreta e n√£o pareada, √© adotado o teste de Kruskal Wallis.\

### `kruskal.test`

Essa fun√ß√£o faz um teste de Kruskal Wallis e √© √∫til apenas para informar se h√° alguma diferen√ßa estat√≠stica significativa entre os grupos.

```{r}
kruskal.test(count ~ spray,
             data = inseticida)
```

### `kruskal` (pacote `agricolae`)

Al√©m de realizar o teste de Kruskal Wallis, faz a compara√ß√£o *post hoc* utilizando o crit√©rio da diferen√ßa menos significativa de Fisher.

```{r}
library(agricolae)

KWT <- kruskal(inseticida$count,
               inseticida$spray,
               group = TRUE)
KWT
```

O teste n√£o param√©trico resultou na mesma resposta que o modelo com os dados transformados (modelo m2).\

### Alternativa 3 - modelo linear generalizado (Generalized Linear Model - GLM)

O uso de modelos lineares generalizados pode ser visto como um m√©todo de transforma√ß√£o mais bonito e elegante que os apresentados anteriormente, mesmo que ambas as metodologias estejam corretas.\
Com o GLM, o modelo (a fun√ß√£o) mais apropriado √© definido de acordo com a distribui√ß√£o dos dados em an√°lise.\
Neste exemplo, ser√° aplicada uma distribui√ß√£o de Poisson, j√° que a vari√°vel resposta √© do tipo num√©rica discreta.

A fun√ß√£o `glm` √© utilizada para ajustar o modelo linear, onde √© preciso indicar a vari√°vel resposta, a vari√°vel independente, a fam√≠lia de distribui√ß√£o de probabilidade e o conjunto de dados utilizado.

```{r}
m4 <- glm(count ~ spray,
          family = poisson,
          data = inseticida)

summary(m4)
anova(m4)
```

```{r}
library(car)
Anova(m4)
```

#### Verifica√ß√£o das pressuposi√ß√µes da ANOVA

```{r}
plot(simulateResiduals(m4))
```

#### Compara√ß√£o de m√©dias --- continuar

```{r}
m4_medias <- emmeans(m4, ~ spray,
                     type =  "response") #para apresentar as m√©dias no formato original, n√£o em log#

m4_medias

cld(m4_medias)
```

## Experimento Fatorial - 2ANOVA

### Importa√ß√£o e visualiza√ß√£o dos dados

```{r}
FAT <- gsheet2tbl("https://docs.google.com/spreadsheets/d/1bq2N19DcZdtax2fQW9OHSGMR0X2__Z9T/edit#gid=2023059672")
```

Ao aplicar o comando `theme_set (theme_bw())`, todos os gr√°ficos gerados a partir da inser√ß√£o deste comando ter√£o o tema designado, no caso "*theme_bw*".

```{r}
theme_set(theme_bw())

FAT %>%
  ggplot(aes(treat, severity, color = factor(dose)))+
  geom_jitter(width = 0.1)


FAT %>%
  ggplot(aes(treat, severity, color = factor(dose)))+
  geom_jitter()+
  facet_wrap(~dose)
```

Acima, foram apresentados dois gr√°ficos para visualiza√ß√£o dos dados. A primeira op√ß√£o, faz uso de cores para apresentar as respostas associados aos n√≠veis do fator dose, enquanto os n√≠veis do fator "treat" s√£o apresentados no eixo x.\
J√° a segunda op√ß√£o, faz uso da fun√ß√£o `facet_wrap`, em que s√£o constru√≠dos dois gr√°ficos, um para cada n√≠vel do fator dose.

### Ajustar o modelo fatorial

Para construir o modelo para experimento com arranjo fatorial ainda ser√° utilizada a fun√ß√£o `lm`. No entanto, como dois ou mais fatores ser√£o avaliados √© preciso incluir as outras vari√°veis independentes no modelo. Dessa forma, a f√≥rmula seria baseada em: vari√°vel `resposta`**\~**`var√≠avel indepedente_1`**\***`var√≠avel indepedente_2`.

```{r}
mf <- lm (severity ~ treat*dose,
          data = FAT)
```

### ANOVA com 2 fatores

```{r}
anova(mf)
```

A an√°lise de vari√¢ncia nos mostra que h√° diferen√ßa entre as m√©dias dos tratamentos (treat, F =4.754e-05), entre as m√©dias das doses (dose, F = 0.0004077), e que tamb√©m h√° diferen√ßas significativas na intera√ß√£o tratamento\*dose (treat:dose, F = 0.0004326).

Portanto, como h√° intera√ß√µes entre fatores, ser√° preciso decompor as m√©dias e realizar compara√ß√µes para os n√≠veis das doses dentro do fator tratamento, e dos n√≠veis do tratamentos dentro do fator dose.

### Verifica√ß√£o das premissas - `DHARMa`

```{r}
plot(simulateResiduals(mf))
```

Os resultados obtidos pelo pacote `DHARMa` demonstram que os dados seguem distribui√ß√£o normal e h√° homogeneidade de vari√¢ncia entre os grupos.

### Compara√ß√£o de m√©dias

Para compara√ß√£o de m√©dias, tamb√©m ser√° utilizada a fun√ß√£o `emmeans`, e para an√°lise de um fator dentro de outro √© preciso indicar a ordem dos fatores, separado por uma barra ( **\|** ).

#### Compara√ß√£o dos n√≠ves do tratamento dentro dos n√≠veis da dose

```{r}
mf_medias <- emmeans(mf, ~ treat | dose)
cld(mf_medias)
```

#### Compara√ß√£o dos n√≠ves da dose dentro dos n√≠veis do tratamento

```{r}
mf_medias <- emmeans(mf, ~ dose | treat) 
cld(mf_medias)
```
